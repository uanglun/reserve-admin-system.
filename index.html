<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>預約管理系統</title>
    <style>
        /* 基礎與通用樣式 */
        body { font-family: '微軟正黑體', Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; display: flex; justify-content: center; min-height: 100vh; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 100%; max-width: 1200px; margin-top: 20px; }
        h1 { color: #007bff; border-bottom: 2px solid #ddd; padding-bottom: 10px; text-align: center; } 
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }

        /* 登入介面樣式 */
        #login-section { 
            max-width: 350px; 
            margin: 100px auto; 
            text-align: center; 
            padding: 40px; 
            border-radius: 8px; 
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        #login-section h1 { 
            color: #28a745; 
            margin-bottom: 30px; 
            border-bottom: none; 
            padding-bottom: 0;
            font-size: 1.8em;
        }
        #login-section label { 
            display: block; 
            text-align: left; 
            margin-top: 15px; 
            margin-bottom: 5px; 
            font-weight: bold; 
            color: #555;
        }
        #login-section input { 
            width: 100%; 
            padding: 10px; 
            margin-bottom: 15px; 
            border: 1px solid #ccc;
            border-radius: 4px; 
            box-sizing: border-box;
            font-size: 16px;
        }
        #login-section button { 
            background-color: #28a745;
            padding: 12px 15px; 
            width: 100%; 
        }
        #login-section button:hover { 
            background-color: #1e7e34;
        }
        #error-message { color: red; margin-top: 15px; }
        .guest-link { color: #dc3545; margin-top: 20px; display: block; font-weight: bold; }

        /* 管理介面樣式 */
        #management-section { display: none; }
        
        .config-block { 
            padding: 15px; 
            margin-bottom: 20px; 
            border-radius: 4px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
        }
        
        /* 系統總狀態控制 */
        #system-config { 
            background-color: #d4edda; 
            border-left: 5px solid #28a745; 
        }
        
        /* 時段封鎖控制 */
        #block-slot-config {
            background-color: #fff3cd; 
            border-left: 5px solid #ffc107; 
            margin-top: 30px; 
            display: block; 
            flex-direction: column; 
            align-items: flex-start;
        }
        #block-slot-config h3 { color: #856404; }
        .block-input-controls { 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        .block-list { 
            max-height: 150px; 
            overflow-y: auto; 
            border: 1px solid #ffc107; 
            padding: 10px; 
            background: #fff; 
            width: 100%; 
            box-sizing: border-box; 
        }
        .block-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 5px 0; 
            border-bottom: 1px dotted #ccc; 
            font-size: 0.9em; 
            color: #856404;
        }
        
        /* 資料備份區塊樣式 (新增) */
        #backup-config {
            background-color: #e6f7ff; 
            border-left: 5px solid #007bff; 
            margin-top: 30px; 
            display: block; 
            flex-direction: column; 
            align-items: flex-start;
        }
        #backup-config h3 { color: #007bff; }
        .backup-controls { 
            display: flex; 
            gap: 15px; 
            align-items: center; 
            margin-bottom: 10px; 
            flex-wrap: wrap;
        }
        .btn-export { background-color: #007bff; }
        .btn-export:hover { background-color: #0056b3; }
        .btn-import { background-color: #28a745; }
        .btn-import:hover { background-color: #1e7e34; }
        .file-input-wrapper { display: flex; align-items: center; }
        .file-input-wrapper input[type="file"] { width: 250px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }


        .config-controls { display: flex; gap: 10px; align-items: center; margin-top: 5px; }
        .config-controls > * { margin-right: 5px; }
        .btn-save { background-color: #ffc107; color: #333; }
        .btn-save:hover { background-color: #e0a800; }
        .btn-logout { background-color: #dc3545; }
        .btn-add-block { background-color: #ffc100; color: #333; }
        .btn-remove-block { background-color: #dc3545; padding: 3px 6px; font-size: 0.8em; }


        /* 今日預約篩選區塊 */
        #today-booking-section { 
            margin-bottom: 20px; 
            padding: 15px; 
            background-color: #e9f7ef; 
            border: 1px solid #28a745; 
            border-radius: 4px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #today-booking-section h3 { margin: 0; color: #28a745; }


        /* 表格樣式 */
        #booking-list { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #booking-list th, #booking-list td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        #booking-list th { background-color: #007bff; color: white; cursor: pointer; }
        
        /* 狀態顏色 */
        .status-waiting { background-color: #fff3cd; color: #856404; font-weight: bold; }
        .status-confirmed { background-color: #d4edda; color: #155724; font-weight: bold; }
        .status-cancelled { background-color: #f8d7da; color: #721c24; }
        .status-completed { background-color: #e2e3e5; color: #495057; }

        /* 操作按鈕 */
        .action-btn { padding: 5px 10px; margin: 2px; border: none; border-radius: 4px; cursor: pointer; color: white; transition: background-color 0.3s; }
        .btn-confirm { background-color: #28a745; }
        .btn-confirm:hover { background-color: #1e7e34; }
        .btn-cancel { background-color: #dc3545; }
        .btn-cancel:hover { background-color: #c82333; }
        .btn-complete { background-color: #6c757d; }
        .btn-complete:hover { background-color: #5a6268; }
        .btn-edit { background-color: #007bff; }
        .btn-delete { background-color: #dc3545; }

        /* Modal 編輯視窗樣式 (保持不變) */
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe; margin: 5% auto; padding: 30px; border: 1px solid #888;
            width: 80%; max-width: 500px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close:hover, .close:focus { color: #000; text-decoration: none; cursor: pointer; }
        .modal-content input, .modal-content select, .modal-content textarea {
            width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;
        }
    </style>
</head>
<body>

    <div class="container">
        
        <div id="login-section">
            <h1>預約管理系統</h1>
            
            <label for="username">帳號</label>
            <input type="text" id="username" required>
            
            <label for="password">密碼</label>
            <input type="password" id="password" required>
            
            <button onclick="handleLogin()">登入</button>
            
            <p id="error-message" style="display: none;">帳號或密碼錯誤，請重新輸入。</p>
            
            <p class="guest-link" style="color: #dc3545; font-weight: bold;">訪客請勿使用</p>
        </div>

        <div id="management-section">
            <h1>預約管理系統</h1>
            
            <div id="system-config" class="config-block">
                <h3 style="margin: 0;">系統預約總狀態控制</h3>
                <div style="flex-grow: 1; margin-left: 20px;">
                    <span id="current-status-display" style="font-weight: bold; margin-right: 15px;"></span>
                </div>
                <div class="config-controls">
                    <span>預計開放時間：</span>
                    <input type="number" id="reopen-value" value="30" min="0" style="width: 60px;">
                    <select id="reopen-unit" style="padding: 5px;">
                        <option value="分鐘">分鐘</option>
                        <option value="小時">小時</option>
                        <option value="天">天</option>
                    </select>
                    <button onclick="saveReopenTime()" class="action-btn btn-save">保存</button>
                    <button onclick="toggleBookingStatus()" id="toggle-btn" class="action-btn btn-cancel">切換狀態</button>
                    <button onclick="logout()" class="action-btn btn-logout">登出</button>
                </div>
            </div>

            <div id="block-slot-config" class="config-block">
                <h3>特定時段封鎖控制 (不開放預約)</h3>
                
                <div class="block-input-controls">
                    <label for="block-date" style="margin: 0;">日期：</label>
                    <input type="date" id="block-date" style="width: 120px; margin: 0;">
                    
                    <label for="block-time" style="margin: 0;">時間：</label>
                    <input type="time" id="block-time" style="width: 80px; margin: 0;">
                    
                    <button onclick="addBlockedSlot()" class="action-btn btn-add-block">新增封鎖時段</button>
                </div>

                <h4>已封鎖時段列表：</h4>
                <div id="blocked-list" class="block-list">
                    <p style="color: #999;">目前沒有封鎖時段。</p>
                </div>
            </div>
            
            <div id="backup-config" class="config-block">
                <h3>資料備份與還原 (CSV 格式)</h3>
                <div class="backup-controls">
                    <button onclick="exportBookingsToCSV()" class="action-btn btn-export">匯出所有預約 (CSV)</button>
                    
                    <div class="file-input-wrapper">
                        <input type="file" id="csv-file-input" accept=".csv" title="選擇 CSV 檔案" onchange="previewCSVFile(this)">
                        <button onclick="handleCSVImport()" class="action-btn btn-import">匯入並覆蓋資料</button>
                    </div>
                </div>
                <p id="csv-preview-message" style="font-size: 0.9em; color: #888; margin-top: 5px;">請選擇 CSV 檔案後，點擊「匯入」按鈕。</p>
            </div>


            <div id="today-booking-section">
                <h3>今日預約篩選</h3>
                <div>
                    <span style="margin-right: 10px; font-weight: bold;">今日日期: <span id="current-date-display"></span></span>
                    <button onclick="filterBookings('all')" id="filter-all">顯示所有預約</button>
                    <button onclick="filterBookings('today')" id="filter-today">顯示今日預約</button>
                </div>
            </div>
            
            <h2>所有預約列表 (總筆數: <span id="booking-count">0</span>)</h2>
            <table id="booking-list">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">日期/時間</th>
                        <th onclick="sortTable(1)">姓名</th>
                        <th onclick="sortTable(2)">人數</th>
                        <th onclick="sortTable(3)">電話</th>
                        <th onclick="sortTable(4)">備註</th>
                        <th onclick="sortTable(5)">ID</th>
                        <th onclick="sortTable(6)">狀態</th>
                        <th style="width: 150px;">操作</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div id="editModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>編輯預約</h2>
                <input type="hidden" id="edit-id">

                <label for="edit-date">日期</label>
                <input type="date" id="edit-date">

                <label for="edit-time">時間</label>
                <input type="time" id="edit-time">

                <label for="edit-pax">人數 (1~10)</label>
                <input type="number" id="edit-pax" min="1" max="10">

                <label for="edit-name">姓名</label>
                <input type="text" id="edit-name">

                <label for="edit-phone">電話</label>
                <input type="tel" id="edit-phone">

                <label for="edit-notes">備註</label>
                <textarea id="edit-notes"></textarea>
                
                <label for="edit-status">狀態</label>
                <select id="edit-status">
                    <option value="等待受理中">等待受理中</option>
                    <option value="已確認">已確認</option>
                    <option value="已取消 (顧客)">已取消 (顧客)</option>
                    <option value="已取消 (員工)">已取消 (員工)</option>
                    <option value="已完成">已完成</option>
                </select>

                <button onclick="saveEditedBooking()">保存變更</button>
            </div>
        </div>

    </div>

    <script>
        const USER_ACCOUNTS = {
            "staff": "062057074",
            "lun": "lunlun1204"
        };

        let bookings = [];
        let blockedSlots = []; 
        let sortColumn = 0;
        let sortDirection = 1; 
        let currentFilter = 'all'; 

        // --- 輔助函式 ---
        function getTodayDateString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // --- 登入/登出功能 ---

        function handleLogin() {
            const enteredUsername = document.getElementById('username').value.toLowerCase(); 
            const enteredPassword = document.getElementById('password').value.toLowerCase(); 
            const errorMessage = document.getElementById('error-message');
            
            if (USER_ACCOUNTS[enteredUsername] === enteredPassword) {
                sessionStorage.setItem('staffLoggedIn', 'true');
                renderPage(); 
            } else {
                errorMessage.style.display = 'block';
            }
        }
        
        function logout() {
            sessionStorage.removeItem('staffLoggedIn');
            alert('您已登出。');
            renderPage(); 
        }
        
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });
        
        // --- 頁面渲染控制 ---

        function renderPage() {
            const isLoggedIn = sessionStorage.getItem('staffLoggedIn') === 'true';
            document.getElementById('login-section').style.display = isLoggedIn ? 'none' : 'block';
            document.getElementById('management-section').style.display = isLoggedIn ? 'block' : 'none';

            if (isLoggedIn) {
                document.getElementById('current-date-display').textContent = getTodayDateString();
                document.getElementById('block-date').min = getTodayDateString();
                document.getElementById('block-date').value = getTodayDateString();
                document.getElementById('block-time').value = '10:00';
                
                loadBookings();
                loadBlockedSlots(); 
                renderSystemStatus();
                renderBlockedSlots(); 
                renderBookings();
            } else {
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('error-message').style.display = 'none';
            }
        }

        // --- 資料載入與儲存 ---

        function loadBookings() {
            const storedBookings = localStorage.getItem('localBookingsData');
            if (storedBookings) {
                bookings = JSON.parse(storedBookings);
            }
        }

        function saveBookings() {
            localStorage.setItem('localBookingsData', JSON.stringify(bookings));
        }

        function getSystemConfig() {
            const config = localStorage.getItem('systemConfig');
            return config ? JSON.parse(config) : { isBookingStopped: false, reopenValue: 30, reopenUnit: '分鐘' };
        }

        function saveSystemConfig(config) {
            localStorage.setItem('systemConfig', JSON.stringify(config));
        }
        
        function loadBlockedSlots() {
            const stored = localStorage.getItem('blockedSlotsData');
            blockedSlots = stored ? JSON.parse(stored) : [];
        }

        function saveBlockedSlots() {
            localStorage.setItem('blockedSlotsData', JSON.stringify(blockedSlots));
        }


        // --- 系統狀態控制 (保持不變) ---
        
        function saveReopenTime() {
            let config = getSystemConfig();
            config.reopenValue = parseInt(document.getElementById('reopen-value').value);
            config.reopenUnit = document.getElementById('reopen-unit').value;
            saveSystemConfig(config);
            renderSystemStatus();
            alert('預計開放時間已保存！');
        }

        function toggleBookingStatus() {
            let config = getSystemConfig();
            
            if (config.isBookingStopped) {
                config.isBookingStopped = false;
                config.reopenValue = 0;
                config.reopenUnit = '';
                alert('預約已重新開放。');
            } else {
                const value = document.getElementById('reopen-value').value;
                const unit = document.getElementById('reopen-unit').value;
                if (!value || parseInt(value) <= 0) {
                    alert('請輸入有效的開放時間！');
                    return;
                }
                config.isBookingStopped = true;
                config.reopenValue = parseInt(value);
                config.reopenUnit = unit;
                alert(`預約已停止。預計在 ${value} ${unit} 後重新開放。`);
            }
            
            saveSystemConfig(config);
            renderSystemStatus();
        }

        function renderSystemStatus() {
            const config = getSystemConfig();
            const statusDisplay = document.getElementById('current-status-display');
            const toggleBtn = document.getElementById('toggle-btn');
            const systemConfigDiv = document.getElementById('system-config');
            
            document.getElementById('reopen-value').value = config.reopenValue;
            document.getElementById('reopen-unit').value = config.reopenUnit;


            if (config.isBookingStopped) {
                statusDisplay.innerHTML = `<span style="color: red;">[已停止]</span> 預計開放時間：${config.reopenValue} ${config.reopenUnit}`;
                toggleBtn.textContent = '重新開啟預約';
                toggleBtn.className = 'action-btn btn-confirm';
                systemConfigDiv.style.backgroundColor = '#f8d7da';
                systemConfigDiv.style.borderLeftColor = '#dc3545';
            } else {
                statusDisplay.innerHTML = `<span style="color: green;">[開放中]</span> 隨時可停止`;
                toggleBtn.textContent = '停止預約';
                toggleBtn.className = 'action-btn btn-cancel';
                systemConfigDiv.style.backgroundColor = '#d4edda';
                systemConfigDiv.style.borderLeftColor = '#28a745';
            }
        }
        
        // --- 特定時段封鎖功能 (保持不變) ---

        function addBlockedSlot() {
            const date = document.getElementById('block-date').value;
            const time = document.getElementById('block-time').value;

            if (!date || !time) {
                alert('請選擇日期和時間！');
                return;
            }

            const isDuplicate = blockedSlots.some(b => b.date === date && b.time === time);
            if (isDuplicate) {
                alert(`此時段 (${date} ${time}) 已在封鎖列表中。`);
                return;
            }

            const newBlock = { date: date, time: time, id: Date.now() };
            blockedSlots.push(newBlock);
            saveBlockedSlots();
            renderBlockedSlots();
            alert(`已新增封鎖時段：${date} ${time}`);
        }

        function removeBlockedSlot(id) {
            if (confirm('確定要解除此時段的封鎖嗎？')) {
                blockedSlots = blockedSlots.filter(b => b.id !== id);
                saveBlockedSlots();
                renderBlockedSlots();
                alert('已解除封鎖。');
            }
        }

        function renderBlockedSlots() {
            const listDiv = document.getElementById('blocked-list');
            listDiv.innerHTML = '';
            
            if (blockedSlots.length === 0) {
                listDiv.innerHTML = '<p style="color: #999; margin: 0;">目前沒有封鎖時段。</p>';
                return;
            }

            const sortedBlocks = blockedSlots.sort((a, b) => {
                const dateTimeA = new Date(`${a.date} ${a.time}`).getTime();
                const dateTimeB = new Date(`${b.date} ${b.time}`).getTime();
                return dateTimeA - dateTimeB;
            });


            sortedBlocks.forEach(b => {
                const item = document.createElement('div');
                item.className = 'block-item';
                item.innerHTML = `
                    <span>${b.date} ${b.time}</span>
                    <button class="action-btn btn-remove-block" onclick="removeBlockedSlot(${b.id})">解除封鎖</button>
                `;
                listDiv.appendChild(item);
            });
        }
        
        // --- 資料備份與還原 (CSV 實作) ---
        
        const CSV_HEADERS = ["id", "date", "time", "pax", "name", "phone", "notes", "status", "timestamp"];
        
        /**
         * 將所有預約資料匯出為 CSV 檔案
         */
        function exportBookingsToCSV() {
            if (bookings.length === 0) {
                alert("目前沒有任何預約資料可供匯出！");
                return;
            }
            
            // 1. 處理標題行
            const headerRow = CSV_HEADERS.join(',');
            
            // 2. 處理資料行
            const dataRows = bookings.map(booking => {
                return CSV_HEADERS.map(header => {
                    let value = booking[header] === undefined ? '' : booking[header];
                    // 處理 CSV 內容中的逗號和換行，用雙引號包住
                    value = String(value).replace(/"/g, '""'); 
                    return `"${value}"`;
                }).join(',');
            }).join('\n');

            const csvContent = headerRow + '\n' + dataRows;
            
            // 3. 建立可下載的 Blob 檔案
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            // 設定下載檔案名稱
            a.setAttribute('href', url);
            a.setAttribute('download', `bookings_backup_${getTodayDateString()}.csv`);
            
            // 觸發下載
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            alert(`已成功匯出 ${bookings.length} 筆預約資料！檔案名稱: bookings_backup_${getTodayDateString()}.csv`);
        }
        
        /**
         * 預覽選中的檔案名稱
         */
        function previewCSVFile(input) {
            const messageDiv = document.getElementById('csv-preview-message');
            if (input.files.length > 0) {
                messageDiv.textContent = `已選取檔案: ${input.files[0].name}，點擊「匯入」覆蓋資料。`;
                messageDiv.style.color = 'green';
            } else {
                messageDiv.textContent = '請選擇 CSV 檔案後，點擊「匯入」按鈕。';
                messageDiv.style.color = '#888';
            }
        }

        /**
         * 處理 CSV 檔案匯入
         */
        function handleCSVImport() {
            const input = document.getElementById('csv-file-input');
            if (input.files.length === 0) {
                alert("請先選擇要匯入的 CSV 檔案！");
                return;
            }

            if (!confirm("警告：匯入 CSV 將會覆蓋您瀏覽器中現有的所有預約資料。您確定要繼續嗎？")) {
                return;
            }

            const file = input.files[0];
            const reader = new FileReader();

            reader.onload = function(event) {
                try {
                    const csvText = event.target.result;
                    const newBookings = parseCSV(csvText);

                    if (newBookings.length === 0) {
                        alert('匯入失敗：CSV 檔案中未找到有效的預約資料。');
                        return;
                    }

                    // 替換現有資料並保存
                    bookings = newBookings;
                    saveBookings();
                    
                    alert(`成功匯入 ${newBookings.length} 筆預約資料！資料已更新。`);
                    
                    // 重新渲染介面
                    renderBookings(); 
                    
                } catch (e) {
                    console.error("CSV 匯入錯誤:", e);
                    alert(`匯入過程中發生錯誤：${e.message}。請檢查 CSV 格式是否正確。`);
                }
            };

            reader.readAsText(file, 'UTF-8');
            input.value = ''; // 清空檔案選擇，以便下次選擇
            previewCSVFile(input); // 更新預覽訊息
        }

        /**
         * 解析 CSV 文本並轉換為預約物件陣列
         */
        function parseCSV(csv) {
            // 簡單解析：使用換行符 (\n) 分割行
            const lines = csv.split('\n').filter(line => line.trim() !== ''); 
            if (lines.length < 2) return []; // 至少需要標題和一行資料

            // 1. 解析標題行 (移除引號並轉小寫)
            const headerLine = lines[0].replace(/"/g, '').toLowerCase();
            const headers = headerLine.split(',').map(h => h.trim());

            // 2. 驗證標題
            const requiredHeaders = ["id", "date", "time", "pax", "name"]; // 檢查必要欄位
            if (!requiredHeaders.every(h => headers.includes(h))) {
                throw new Error("CSV 標題缺少必要欄位 (id, date, time, pax, name) 或格式不正確。");
            }

            const results = [];
            // 3. 處理資料行 (從第二行開始)
            for (let i = 1; i < lines.length; i++) {
                // 使用正則表達式來處理雙引號內的逗號 (簡易版，不處理複雜的 CSV 逸出)
                const values = lines[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                if (!values) continue; 

                const booking = {};
                for (let j = 0; j < headers.length && j < values.length; j++) {
                    let value = values[j].replace(/"/g, '').trim();
                    const header = headers[j];

                    // 處理資料類型轉換
                    if (header === 'id' || header === 'pax') {
                        booking[header] = parseInt(value) || 0;
                    } else {
                        booking[header] = value;
                    }
                }

                // 確保預約物件有必要的欄位
                if (booking.id && booking.date && booking.time) {
                    results.push(booking);
                }
            }
            return results;
        }


        // --- 預約列表篩選 (保持不變) ---
        function filterBookings(filterType) {
            currentFilter = filterType;
            renderBookings();
            
            document.getElementById('filter-all').style.fontWeight = (filterType === 'all') ? 'bold' : 'normal';
            document.getElementById('filter-today').style.fontWeight = (filterType === 'today') ? 'bold' : 'normal';
        }

        // --- 預約列表渲染與操作 (保持不變) ---

        function renderBookings() {
            const tbody = document.getElementById('booking-list').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            
            let displayBookings = [...bookings];
            if (currentFilter === 'today') {
                const todayDate = getTodayDateString();
                displayBookings = bookings.filter(b => b.date === todayDate);
            }

            const sortedBookings = sortData(displayBookings, sortColumn, sortDirection);

            document.getElementById('booking-count').textContent = sortedBookings.length;

            sortedBookings.forEach((booking, index) => {
                const row = tbody.insertRow();
                
                let statusClass = '';
                if (booking.status && booking.status.includes('等待')) statusClass = 'status-waiting';
                else if (booking.status && booking.status.includes('確認')) statusClass = 'status-confirmed';
                else if (booking.status && booking.status.includes('取消')) statusClass = 'status-cancelled';
                else if (booking.status && booking.status.includes('完成')) statusClass = 'status-completed';

                row.insertCell().textContent = `${booking.date || '-'} ${booking.time || '-'}`;
                row.insertCell().textContent = booking.name || '-';
                row.insertCell().textContent = `${booking.pax || 0} 人`;
                row.insertCell().textContent = booking.phone || '-';
                row.insertCell().textContent = booking.notes || '-';
                row.insertCell().textContent = booking.id || '-';
                const statusCell = row.insertCell();
                statusCell.textContent = booking.status || '-';
                statusCell.className = statusClass;

                const actionCell = row.insertCell();
                let actionButtons = `
                    <button class="action-btn btn-edit" onclick="openEditModal(${booking.id})">編輯</button>
                    <button class="action-btn btn-delete" onclick="deleteBooking(${booking.id})">刪除</button>
                `;

                if (!booking.status || (!booking.status.includes('取消') && !booking.status.includes('完成'))) {
                    actionButtons += `
                        <button class="action-btn btn-confirm" onclick="updateBookingStatus(${booking.id}, '已確認')">確認</button>
                        <button class="action-btn btn-complete" onclick="updateBookingStatus(${booking.id}, '已完成')">完成</button>
                    `;
                }

                actionCell.innerHTML = actionButtons;
            });
        }

        function updateBookingStatus(id, newStatus) {
            const bookingIndex = bookings.findIndex(b => b.id === id);
            if (bookingIndex > -1) {
                bookings[bookingIndex].status = newStatus;
                saveBookings();
                renderBookings();
                alert(`預約 ID ${id} 的狀態已更新為：${newStatus}`);
            }
        }
        
        function deleteBooking(id) {
            if (confirm(`確定要刪除預約 ID ${id} 的資料嗎？此操作無法復原。`)) {
                const bookingIndex = bookings.findIndex(b => b.id === id);
                if (bookingIndex > -1) {
                    bookings.splice(bookingIndex, 1); 
                    saveBookings();
                    renderBookings();
                    alert(`預約 ID ${id} 已成功刪除。`);
                }
            }
        }

        // --- 編輯功能 (Modal) (保持不變) ---
        function openEditModal(id) {
            const booking = bookings.find(b => b.id === id);
            if (!booking) return;

            document.getElementById('edit-id').value = booking.id;
            document.getElementById('edit-date').value = booking.date;
            document.getElementById('edit-time').value = booking.time;
            document.getElementById('edit-pax').value = booking.pax;
            document.getElementById('edit-name').value = booking.name;
            document.getElementById('edit-phone').value = booking.phone;
            document.getElementById('edit-notes').value = booking.notes || '';
            document.getElementById('edit-status').value = booking.status;

            document.getElementById('editModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        function saveEditedBooking() {
            const id = parseInt(document.getElementById('edit-id').value);
            const bookingIndex = bookings.findIndex(b => b.id === id);

            if (bookingIndex > -1) {
                bookings[bookingIndex].date = document.getElementById('edit-date').value;
                bookings[bookingIndex].time = document.getElementById('edit-time').value;
                bookings[bookingIndex].pax = parseInt(document.getElementById('edit-pax').value);
                bookings[bookingIndex].name = document.getElementById('edit-name').value;
                bookings[bookingIndex].phone = document.getElementById('edit-phone').value;
                bookings[bookingIndex].notes = document.getElementById('edit-notes').value;
                bookings[bookingIndex].status = document.getElementById('edit-status').value;
                
                saveBookings();
                renderBookings();
                closeModal();
                alert(`預約 ID ${id} 已更新！`);
            } else {
                alert('保存失敗：找不到該筆預約資料。');
            }
        }

        // --- 排序功能 (保持不變) ---
        
        function sortData(data, columnIndex, direction) {
            const columns = ['dateTime', 'name', 'pax', 'phone', 'notes', 'id', 'status'];
            const columnKey = columns[columnIndex];
            
            return data.sort((a, b) => {
                let aValue, bValue;

                if (columnKey === 'dateTime') {
                    aValue = new Date(`${a.date} ${a.time}`).getTime();
                    bValue = new Date(`${b.date} ${b.time}`).getTime();
                    
                } else if (columnKey === 'pax' || columnKey === 'id') {
                    aValue = parseFloat(a[columnKey]);
                    bValue = parseFloat(b[columnKey]);
                } else {
                    aValue = String(a[columnKey]).toLowerCase();
                    bValue = String(b[columnKey]).toLowerCase();
                }

                if (aValue < bValue) return -1 * direction;
                if (aValue > bValue) return 1 * direction;
                return 0;
            });
        }
        
        function sortTable(columnIndex) {
            if (sortColumn === columnIndex) {
                sortDirection *= -1; 
            } else {
                sortColumn = columnIndex;
                sortDirection = 1; 
            }
            renderBookings();
        }

        // --- 初始化 ---

        window.onload = renderPage; 
        
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
</body>
</html>
